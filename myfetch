#!/usr/bin/env bash
# Colors
PURPLE=$'\033[35m'
BLUE=$'\033[1;34m'
TEAL=$'\033[38;5;43m'
TEAL_DIM=$'\033[36m'
WHITE=$'\033[1;37m'
ORANGE=$'\033[38;5;208m'
GREEN=$'\033[32m'
RESET=$'\033[0m'

prox_os=""
if command -v pveversion >/dev/null 2>& 1; then
   ver=$(pveversion | head -n1 | cut -d'/' -f2 | cut -d'-' -f1)
   prox_os="Proxmox VE ${ver:+ $ver}"
fi

# === Determine label color based on distro (before building lines) ===
_distro_id=$(grep '^ID=' /etc/os-release 2>/dev/null | cut -d'=' -f2 | tr -d '"')
_distro_base=$(grep '^ID_LIKE=' /etc/os-release 2>/dev/null | cut -d'=' -f2 | tr -d '"')

if [ -n "$prox_os" ]; then
    label_color="$ORANGE"
else
    case "$_distro_id" in
        arch|endeavouros|manjaro|garuda)
            label_color="$BLUE" ;;
        ubuntu)
            label_color="$ORANGE" ;;
        linuxmint)
            label_color="$GREEN" ;;
        pop)
            label_color="$TEAL" ;;
        cachyos)
            label_color="$TEAL" ;;
        void)
            label_color="$GREEN" ;;
        nixos)
            label_color="$BLUE" ;;
        *)
            case "$_distro_base" in
                *arch*)             label_color="$BLUE" ;;
                *ubuntu*|*debian*)  label_color="$ORANGE" ;;
                *)                  label_color="$PURPLE" ;;
            esac
            ;;
    esac
fi

# === Gather system info ===
if [ -n "$prox_os" ]; then
    os="$prox_os"
else
    os_name=$(grep '^NAME=' /etc/os-release 2>/dev/null | cut -d'"' -f2 || echo 'Linux')
    os_version=$(grep '^VERSION=' /etc/os-release 2>/dev/null | cut -d'"' -f2 || echo '')
    os="$os_name${os_version:+ $os_version}"
fi
kernel="$(uname -r)"
device="$(cat /sys/devices/virtual/dmi/id/product_name 2>/dev/null || echo 'Unknown')"
uptime=$(uptime -p 2>/dev/null || echo "unknown")
uptime=${uptime#up }
terminal="${BASH_VERSION}"
res_output=$(xrandr --query 2>/dev/null)
display_res=$(echo "$res_output" | grep " primary" | grep -oP '\d+x\d+' || echo "unknown")
display_res2=$(echo "$res_output" | grep " connected" | grep -v " primary" | grep -oP '\d+x\d+' | head -n1 || echo "")
cpu_info="$(lscpu | grep "Model name:" | cut -d':' -f2 | xargs) @ $(lscpu | grep "CPU MHz:" | awk '{printf "%.1f GHz", $3/1000}' || echo "unknown")"
gpu_info=$(command -v lspci >/dev/null && lspci | grep -i vga || echo "Unknown")
ram_used=$(free -h | awk '/^Mem:/ {print $3}')
ram_total=$(free -h | awk '/^Mem:/ {print $2}')
ram="$ram_used / $ram_total"

# === Build colored lines (labels use label_color to match the logo) ===
lines=()
lines+=("${label_color}OS:${RESET} $os")
lines+=("${label_color}Kernel:${RESET} Linux $kernel")
lines+=("${label_color}Device:${RESET} $device")
lines+=("${label_color}Uptime:${RESET} $uptime")
lines+=("${label_color}Terminal:${RESET} $terminal")
lines+=("${label_color}Display-res:${RESET} $display_res")
[ -n "$display_res2" ] && lines+=("${label_color}Display-res2:${RESET} $display_res2")
lines+=("${label_color}CPU-info:${RESET} $cpu_info")
lines+=("${label_color}GPU-info:${RESET} $gpu_info")
lines+=("${label_color}Ram:${RESET} $ram")

# === Box sizing (strip colors correctly for width) ===
max_len=0
for line in "${lines[@]}"; do
    clean=$(echo -e "$line" | sed 's/\x1b\[[0-9;]*m//g')
    len=${#clean}
    (( len > max_len )) && max_len=$len
done

box_content_width=$max_len
box_inner_width=$((box_content_width + 2))
border=$(printf '─%.0s' $(seq 1 $box_inner_width))

# ASCII
distro_id=$(cat /etc/os-release 2>/dev/null | grep '^ID=' | cut -d'=' -f2 | tr -d '"')
distro_base=$(cat /etc/os-release 2>/dev/null | grep '^ID_LIKE=' | cut -d'=' -f2 | tr -d '"')

# === ASCII selection ===
if [ -n "$prox_os" ]; then
    o="$ORANGE"
    w="$WHITE"
    r="$RESET"
    IFS= read -r -d '' ascii <<EOF
             ${w}@@@@${r}   ${w}@@@@${r}
          ${o}++++${r} ${w}@@@@@@@${r} ${o}++++${r}
            ${o}++++${r} ${w}@@@${r} ${o}++++${r}
              ${o}++++ ++++${r}
             ${o}++++${r}${w}@@@${r}${o}++++${r}
           ${o}++++${r} ${w}@@@@@${r} ${o}++++${r}
          ${o}+++${r} ${w}@@@@${r} ${w}@@@@${r} ${o}+++${r}
             ${w}@@@${r}     ${w}@@@${r}

EOF
else
    distro_id=$(grep '^ID=' /etc/os-release 2>/dev/null | cut -d'=' -f2 | tr -d '"')
    distro_base=$(grep '^ID_LIKE=' /etc/os-release 2>/dev/null | cut -d'=' -f2 | tr -d '"')

    case "$distro_id" in
        arch|endeavouros|manjaro|garuda)
            IFS= read -r -d '' ascii <<'EOF'
                   -`
                  .o+`
                 `ooo/
                `+oooo:
               `+oooooo:
               -+oooooo+:
             `/:-:++oooo+:
            `/++++/+++++++:
           `/++++++++++++++:
          `/+++ooooooooooooo/`
         ./ooosssso++osssssso+`
        .oossssso-````/ossssss+`
       -osssssso.      :ssssssso.
      :osssssss/        osssso+++.
     /ossssssss/        +ssssooo/-
   `/ossssso+/:-        -:/+osssso+-
  `+sso+:-`                 `.-/+oso:
 `++:.                           `-/+/
 .`                                 `

EOF
        ;;
    ubuntu)
        IFS= read -r -d '' ascii <<'EOF'

              ===========
          ===================
        =======================
      =================     =====
     ==========       =     ======
    ========= -=        ===========
   ========    .=======.    ========
  ========    ===========    ========
  ====   =   =============   :=======
  ===     =  ========================
  ====   =   =============   :=======
  ========    ===========    ========
   ========    .=======:    ========
    ========= -=        ===========
     ==========       =     ======
      =================     =====
        =======================
          ===================
              ===========


EOF
        ;;
    linuxmint)
        IFS= read -r -d '' ascii <<'EOF'

         .                   .
            ===============
         =====================
   .   =========================   .
      ===...=====================
 .   ====...=====.....=.....======   .
    =====...===...............=====
   ======...===...===...===...======
   ======...===...===...===...======
   ======...===...===...===...======
   ======...===...===...===...======
   ======...===...===...===...======
    =====...===============...=====
 .   =====...................=====   .
      ======...............======
   .   =========================
         =====================
            ===============
         .                   .


EOF
        ;;
    pop)
        IFS= read -r -d '' ascii <<'EOF'

            .++++++++++++*..
         .++++++++++++++*****.
       .+++.........++*********.
      +++.....+-.....+***********
     ++++.....+++.....************
    ++++++.....+**....***....******
   .+++++++.....*=...+**.....******.
   +++++++++........****....********
   ++++++++**.....******...*********
   ++++++*****....******..**********
   .+++********....****************.
    +***********....***..**********
     *****************************
      *****.................*****
       .***.................***.
         .*******************.
           ..*************..



EOF
        ;;
    cachyos)
        t="$TEAL"
        d="$TEAL_DIM"
        r="$RESET"
        IFS= read -r -d '' ascii <<EOF

        ${t}**${d}++++++++++++++++${t}*${r}
       ${d}=++++${t}*${d}+++++++++++++${r}      ${d}=${r}
      ${d}==+++==++${t}*${d}+++++++++${r}      ${d}=--${r}
     ${d}===++++====++++++++${r}        ${d}=${r}
    ${d}====+++++++++++++++${r}
   ${d}=====++++${r}                ${d}+++${r}
  ${d}===+++${t}*${d}++${r}                ${d}=====${r}
 ${t}+++++++${t}*${d}+${r}                  ${d}---${r}
${d}========${t}*${r}
 ${d}===++++++${r}                        ${d}++++${r}
  ${d}+${t}*${d}+++++++${r}                      ${d}======${r}
   ${d}+++${t}***${d}+++=                     ${d}----${r}
     ${d}+++++===+++=================${r}
      ${d}++++==+++++${t}*${d}+============${r}
       ${d}+++=+++++++++++========${r}
        ${d}+++++++++++++++++====${r}
         ${d}+++++++++++++++++++${r}
EOF
        ;;
    void)
        IFS= read -r -d '' ascii <<'EOF'
                -------
              -----------
               -----------
            *   --   ------
            **         ----
           ****    -    ----
         @@****@@*++=-@@#+++@@
         @@@**@@@%+@@=@@@@+#@@
          @@%%@@@=-@@#@@@%-#@@
          @@#* @@*%@+@@@@%#@@@
           **** @*=--*@@%++=
           ****    -    ----
            ****         --
            ******    *   -
             ***********
              ***********
                *******

EOF
        ;;
    nixos)
        b="$BLUE"
        w="$WHITE"
        r="$RESET"
        IFS= read -r -d '' ascii <<EOF
         ${b}+++${r}     ${w}-----   ---${r}         
         ${b}+++*${r}     ${w}----- ----${r}         
          ${b}++**${r}     ${w}--------${r}          
     ${b}+++++++********${r}${w}---===${r}     ${b}+${r}     
    ${b}++++++++*********${r}${w}-====${r}    ${b}+++${r}    
          ${w}=====${r}       ${w}=====${r}  ${b}+++++${r}   
         ${w}====${r}           ${w}====${r}${b}++++${r}     
 ${w}--=-=======${r}             ${w}==${r}${b}**+++++++${r} 
${w}-------====${r}               ${b}******+++++${r}
 ${w}--------=${r}${b}**${r}             ${b}**********+${r} 
     ${w}----${r}${b}****${r}           ${b}****${r}         
    ${w}----${r}  ${b}*****${r}       ${b}*****${r}          
    ${w}---${r}    ${b}****+${r}${w}=========${w}--------${r}    
     ${w}-${r}     ${b}*****+${r}${w}=======${w}--------${r}     
          ${b}**++++++${r}     ${w}=---${r}          
         ${b}++++ +++++${r}     ${w}----${r}         
         ${b}+++   +++++${r}     ${w}---${r}         

EOF
        ;;
    *)
        case "$distro_base" in
            *arch*)
                IFS= read -r -d '' ascii <<'EOF'
                   -`
                  .o+`
                 `ooo/
                `+oooo:
               `+oooooo:
               -+oooooo+:
             `/:-:++oooo+:
            `/++++/+++++++:
           `/++++++++++++++:
          `/+++ooooooooooooo/`
         ./ooosssso++osssssso+`
        .oossssso-````/ossssss+`
       -osssssso.      :ssssssso.
      :osssssss/        osssso+++.
     /ossssssss/        +ssssooo/-
   `/ossssso+/:-        -:/+osssso+-
  `+sso+:-`                 `.-/+oso:
 `++:.                           `-/+/
 .`                                 `

EOF
                ;;
            *ubuntu*|*debian*)
                IFS= read -r -d '' ascii <<'EOF'

              ===========
          ===================
        =======================
      =================     =====
     ==========       =     ======
    ========= -=        ===========
   ========    .=======.    ========
  ========    ===========    ========
  ====   =   =============   :=======
  ===     =  ========================
  ====   =   =============   :=======
  ========    ===========    ========
   ========    .=======:    ========
    ========= -=        ===========
     ==========       =     ======
      =================     =====
        =======================
          ===================
              ===========

EOF
                ;;
            *)
                IFS= read -r -d '' ascii <<'EOF'
         _nnnn_
        dGGGGMMb
       @p~qp~~qMb
       M|@||@) M|
       @,----.JM|
      JS^\__/  qKL
     dZP        qKRb
    dZP          qKKb
   fZP            SMMb
   HZM            MMMM
   FqM            MMMM
 __| ".        |\dS"qML
 |    `.       | `' \Zq
_)      \.___.,|     .'
\____   )MMMMMP|   .'
     `-'       `--'

EOF
                ;;
        esac
        ;;
esac
fi

mapfile -t ascii_arr <<< "$ascii"
# === Print side-by-side ===
box_height=$((${#lines[@]} + 2))

for (( i=0; i < ${#ascii_arr[@]}; i++ )); do
    left="${ascii_arr[i]}"

    right=""
    if (( i < box_height )); then
        if (( i == 0 )); then
            right="╭${border}╮"
        elif (( i == box_height - 1 )); then
            right="╰${border}╯"
        else
            idx=$((i - 1))
            content="${lines[idx]}"
            clean_content=$(echo -e "$content" | sed 's/\x1b\[[0-9;]*m//g')
            content_len=${#clean_content}
            total_padding=$((box_content_width - content_len))
            right="│ "
            right+="${content}"
            for (( p=0; p<total_padding; p++ )); do
                right+=" "
            done
            right+=" │"
        fi
    fi

    # FIX: measure visible (stripped) length of left to calculate correct padding
    clean_left=$(printf "%s" "$left" | sed 's/\x1b\[[0-9;]*m//g')
    visible_len=${#clean_left}
    pad=$(( 40 - visible_len ))
    (( pad < 0 )) && pad=0
    printf "%s%${pad}s%s\n" "$left" "" "$right"
done
echo ""
